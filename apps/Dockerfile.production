# =====================================================
# PRODUCTION DOCKERFILE - DoganHub Store
# Enterprise-grade multi-stage build with full features
# =====================================================

FROM node:18-alpine AS base
LABEL maintainer="DoganHub Development Team"
LABEL description="DoganHub Store - Enterprise Business Management Platform"
LABEL version="1.0.0"

# Install system dependencies for production
RUN apk add --no-cache \
    libc6-compat \
    bash \
    curl \
    wget \
    ca-certificates \
    && rm -rf /var/cache/apk/*

# Set working directory
WORKDIR /app

# =====================================================
# STAGE 1: Dependencies Installation
# =====================================================
FROM base AS deps

# Copy package files for dependency installation
COPY package.json package-lock.json* yarn.lock* pnpm-lock.yaml* ./

# Install dependencies based on available lock file
RUN \
    if [ -f yarn.lock ]; then \
        echo "Installing with Yarn..." && \
        yarn --frozen-lockfile --production=false; \
    elif [ -f package-lock.json ]; then \
        echo "Installing with NPM..." && \
        npm ci --include=dev; \
    elif [ -f pnpm-lock.yaml ]; then \
        echo "Installing with PNPM..." && \
        npm install -g pnpm && \
        pnpm install --frozen-lockfile; \
    else \
        echo "No lockfile found. Installing with NPM..." && \
        npm install; \
    fi

# =====================================================
# STAGE 2: Application Builder
# =====================================================
FROM base AS builder
WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules

# Copy all source code and configuration files
COPY . .

# Copy environment files (if they exist)
COPY .env* ./

# Set build environment variables
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV SKIP_ENV_VALIDATION=1

# Create necessary directories
RUN mkdir -p \
    .next \
    public \
    uploads \
    logs \
    temp

# Set permissions for build directories
RUN chmod -R 755 public uploads logs temp

# Build the application with all optimizations
RUN echo "Building DoganHub Store application..." && \
    npm run build && \
    echo "Build completed successfully!"

# Generate static exports if needed
RUN echo "Optimizing static assets..." && \
    find .next/static -name "*.js" -type f -exec gzip -k {} \; && \
    find .next/static -name "*.css" -type f -exec gzip -k {} \; && \
    echo "Static optimization completed!"

# =====================================================
# STAGE 3: Production Runtime
# =====================================================
FROM base AS runner
WORKDIR /app

# Set production environment
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

# Create system user for security
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copy public assets with proper permissions
COPY --from=builder --chown=nextjs:nodejs /app/public ./public

# Copy i18n locales if they exist
COPY --from=builder --chown=nextjs:nodejs /app/locales ./locales || true

# Copy configuration files
COPY --from=builder --chown=nextjs:nodejs /app/next.config.js ./
COPY --from=builder --chown=nextjs:nodejs /app/package.json ./

# Create and set permissions for application directories
RUN mkdir -p \
    .next \
    uploads \
    logs \
    temp \
    data && \
    chown -R nextjs:nodejs \
    .next \
    uploads \
    logs \
    temp \
    data

# Copy Next.js build output
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# Copy additional assets and features
COPY --from=builder --chown=nextjs:nodejs /app/styles ./styles || true
COPY --from=builder --chown=nextjs:nodejs /app/components ./components || true
COPY --from=builder --chown=nextjs:nodejs /app/lib ./lib || true
COPY --from=builder --chown=nextjs:nodejs /app/types ./types || true
COPY --from=builder --chown=nextjs:nodejs /app/utils ./utils || true

# Copy API routes and server components
COPY --from=builder --chown=nextjs:nodejs /app/app ./app || true
COPY --from=builder --chown=nextjs:nodejs /app/pages ./pages || true

# Copy database and service files
COPY --from=builder --chown=nextjs:nodejs /app/prisma ./prisma || true
COPY --from=builder --chown=nextjs:nodejs /app/Services ./Services || true

# Copy documentation and metadata
COPY --from=builder --chown=nextjs:nodejs /app/*.md ./ || true
COPY --from=builder --chown=nextjs:nodejs /app/*.json ./ || true
COPY --from=builder --chown=nextjs:nodejs /app/*.yml ./ || true
COPY --from=builder --chown=nextjs:nodejs /app/*.yaml ./ || true

# Copy scripts and tools
COPY --from=builder --chown=nextjs:nodejs /app/scripts ./scripts || true
COPY --from=builder --chown=nextjs:nodejs /app/__tests__ ./__tests__ || true

# Create server startup script
RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'echo "ðŸš€ Starting DoganHub Store Production Server..."' >> /app/start.sh && \
    echo 'echo "ðŸ“Š Environment: $NODE_ENV"' >> /app/start.sh && \
    echo 'echo "ðŸŒ Port: $PORT"' >> /app/start.sh && \
    echo 'echo "ðŸ”§ Hostname: $HOSTNAME"' >> /app/start.sh && \
    echo 'echo "ðŸ¢ Platform: DoganHub Enterprise"' >> /app/start.sh && \
    echo 'echo "ðŸŒ Features: 104 APIs, Bilingual Support, Enterprise Modules"' >> /app/start.sh && \
    echo 'echo "âœ… Server starting on http://$HOSTNAME:$PORT"' >> /app/start.sh && \
    echo 'node server.js' >> /app/start.sh && \
    chmod +x /app/start.sh && \
    chown nextjs:nodejs /app/start.sh

# Create health check script
RUN echo '#!/bin/bash' > /app/health.sh && \
    echo 'curl -f http://localhost:$PORT/api/health || exit 1' >> /app/health.sh && \
    chmod +x /app/health.sh && \
    chown nextjs:nodejs /app/health.sh

# Switch to non-root user
USER nextjs

# Expose application port
EXPOSE 3000

# Add comprehensive health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD /app/health.sh

# Add labels for production metadata
LABEL org.label-schema.name="DoganHub Store"
LABEL org.label-schema.description="Enterprise Business Management Platform"
LABEL org.label-schema.version="1.0.0"
LABEL org.label-schema.schema-version="1.0"
LABEL org.label-schema.build-date="2025-11-13"
LABEL features="104-APIs,Bilingual-Support,Enterprise-Modules,Docker-Ready"
LABEL architecture="Next.js-16,Node.js-18,TypeScript,PostgreSQL,Redis"

# Start the application
CMD ["/app/start.sh"]