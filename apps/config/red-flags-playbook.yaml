# Red Flags Immediate Action Playbook
# دليل الإجراءات الفورية للأعلام الحمراء
# Multi-tenant, Real-time Detection & Response

version: "1.0"
metadata:
  name: "Red Flags Immediate Action Playbook"
  description: "Comprehensive incident response for financial red flags"
  author: "Saudi Store Platform"
  created: "2024-11-11"
  updated: "2024-11-11"

# ========================================
# Global Configuration
# ========================================
global:
  incident_mode:
    auto_activate: true
    freeze_threshold: "high"  # critical, high, medium, low
    evidence_retention_days: 2555  # 7 years
    notification_timeout_seconds: 60
    
  thresholds:
    materiality_amount: 10000  # SAR
    rapid_succession_count: 5
    rapid_succession_window_minutes: 10
    duplicate_detection_window_hours: 24
    sanctions_confidence_threshold: 0.7
    
  notifications:
    slack:
      webhook_url: "${SLACK_WEBHOOK_URL}"
      channels:
        critical: "#incidents-critical"
        high: "#finance-alerts"
        medium: "#compliance-alerts"
    
    email:
      smtp_host: "${SMTP_HOST}"
      from_address: "alerts@saudistore.com"
      recipients:
        cfo: ["cfo@saudistore.com"]
        compliance: ["compliance@saudistore.com"]
        audit: ["audit@saudistore.com"]
        security: ["security@saudistore.com"]
    
    sms:
      provider: "twilio"
      api_key: "${TWILIO_API_KEY}"
      critical_numbers: ["+966501234567"]

# ========================================
# Red Flag Types & Response Rules
# ========================================
red_flags:
  
  # 1. Accounting Equation Not Balanced
  accounting_unbalanced:
    severity: "high"
    auto_containment: true
    containment_actions:
      - action: "freeze_gl_posting"
        target: "tenant"
        condition: "imbalance > 0.01"
      - action: "move_to_suspense"
        target: "journal"
        account: "SUSPENSE"
    
    detection_sql: |
      SELECT 
        ge.tenant_id,
        ge.journal_id,
        ge.doc_no,
        SUM(ge.debit)::NUMERIC(18,2) AS debit_total,
        SUM(ge.credit)::NUMERIC(18,2) AS credit_total,
        (SUM(ge.debit) - SUM(ge.credit))::NUMERIC(18,2) AS imbalance
      FROM gl_entries ge
      WHERE ge.tenant_id = :tenant_id
      GROUP BY ge.tenant_id, ge.journal_id, ge.doc_no
      HAVING ABS(SUM(ge.debit) - SUM(ge.credit)) > 0.01
    
    agent_job: "FIN_REPAIR_UNBALANCED"
    notifications:
      - type: "email"
        recipients: ["cfo", "audit"]
        template: "unbalanced_journal"
      - type: "slack"
        channel: "#finance-alerts"
        urgency: "high"
    
    sla:
      acknowledgment_minutes: 30
      resolution_hours: 4
      escalation_hours: 2

  # 2. Duplicate Transaction
  duplicate_transaction:
    severity: "medium"
    auto_containment: true
    containment_actions:
      - action: "flag_as_suspect"
        target: "payment"
        status: "duplicate_suspect"
      - action: "hold_settlement"
        target: "payment"
    
    detection_sql: |
      WITH transaction_signatures AS (
        SELECT 
          id, txn_date::DATE as txn_date,
          md5(COALESCE(counterparty_id::TEXT, '') || '|' ||
              COALESCE(reference, '') || '|' || amount::TEXT) AS signature
        FROM payments 
        WHERE tenant_id = :tenant_id 
        AND status = 'posted'
        AND txn_date >= NOW() - INTERVAL '24 hours'
      )
      SELECT signature, txn_date, COUNT(*) as duplicate_count,
             array_agg(id::TEXT) as transaction_ids
      FROM transaction_signatures
      GROUP BY signature, txn_date
      HAVING COUNT(*) > 1
    
    agent_job: "FIN_DEDUP_REVIEW"
    notifications:
      - type: "email"
        recipients: ["cfo"]
        template: "duplicate_transaction"
    
    sla:
      acknowledgment_minutes: 60
      resolution_hours: 8

  # 3. Sanctioned Entity
  sanctioned_entity:
    severity: "critical"
    auto_containment: true
    containment_actions:
      - action: "freeze_entity"
        target: "counterparty"
        status: "frozen"
      - action: "block_payments"
        target: "counterparty"
      - action: "hold_balances"
        target: "counterparty"
    
    detection_sql: |
      SELECT c.id, c.name, sw.list_name, sw.entry_id,
             CASE 
               WHEN sw.name = c.name THEN 'exact_name'
               WHEN sw.iban = c.iban THEN 'exact_iban'
               WHEN similarity(sw.name, c.name) > 0.8 THEN 'fuzzy_name'
               ELSE 'partial_match'
             END as match_type,
             CASE 
               WHEN sw.name = c.name OR sw.iban = c.iban THEN 1.0
               ELSE similarity(sw.name, c.name)
             END as confidence_score
      FROM counterparties c
      JOIN sanctions_watchlist sw ON (
        sw.name = c.name OR sw.iban = c.iban OR 
        similarity(sw.name, c.name) > :confidence_threshold
      )
      WHERE c.tenant_id = :tenant_id AND c.status = 'active'
    
    agent_job: "COMPLIANCE_CASE_OPEN"
    notifications:
      - type: "email"
        recipients: ["compliance", "cfo", "audit"]
        template: "sanctions_hit"
        priority: "urgent"
      - type: "sms"
        recipients: "critical_numbers"
        message: "URGENT: Sanctions screening hit detected"
      - type: "slack"
        channel: "#incidents-critical"
        urgency: "critical"
    
    sla:
      acknowledgment_minutes: 15
      resolution_hours: 2
      escalation_minutes: 30

  # 4. Audit Trail Tampered
  audit_tampered:
    severity: "critical"
    auto_containment: true
    containment_actions:
      - action: "revoke_write_access"
        target: "user"
        scope: "all_tables"
      - action: "forensic_snapshot"
        target: "database"
        retention: "permanent"
    
    detection_sql: |
      -- Detect sequence gaps
      WITH sequence_gaps AS (
        SELECT seq_no, LAG(seq_no) OVER (ORDER BY seq_no) as prev_seq,
               created_at, LAG(created_at) OVER (ORDER BY seq_no) as prev_time
        FROM audit_logs WHERE tenant_id = :tenant_id
        ORDER BY seq_no
      )
      SELECT (sg.prev_seq + 1) as expected_seq, sg.seq_no as actual_seq,
             (sg.seq_no - sg.prev_seq - 1) as gap_size,
             sg.prev_time as gap_start_time, sg.created_at as gap_end_time
      FROM sequence_gaps sg
      WHERE sg.prev_seq IS NOT NULL AND sg.seq_no != sg.prev_seq + 1
    
    agent_job: "SEC_FORENSIC_SNAPSHOT"
    notifications:
      - type: "email"
        recipients: ["security", "audit", "cfo"]
        template: "audit_tampering"
        priority: "critical"
      - type: "sms"
        recipients: "critical_numbers"
        message: "CRITICAL: Audit trail tampering detected"
      - type: "slack"
        channel: "#incidents-critical"
        urgency: "critical"
    
    sla:
      acknowledgment_minutes: 10
      resolution_hours: 1
      escalation_minutes: 15

  # 5. Large Unexplained Transaction
  large_unexplained:
    severity: "high"
    auto_containment: true
    containment_actions:
      - action: "hold_transaction"
        target: "payment"
        status: "on_hold"
      - action: "request_documents"
        target: "payment"
        required_docs: ["invoice", "contract", "approval"]
    
    detection_sql: |
      SELECT p.id::TEXT as payment_id, p.txn_date::DATE, p.amount,
             p.counterparty_id::TEXT, (d.id IS NOT NULL) as has_documents,
             EXTRACT(DAY FROM NOW() - p.txn_date)::INTEGER as days_without_docs
      FROM payments p
      LEFT JOIN documents d ON d.entity_type = 'payment' AND d.entity_id = p.id::TEXT
      WHERE p.tenant_id = :tenant_id
      AND p.amount >= :materiality_threshold
      AND p.status = 'posted' AND d.id IS NULL
      AND p.txn_date >= NOW() - INTERVAL '30 days'
    
    agent_job: "FIN_SUPPORTING_DOCS_REQUEST"
    notifications:
      - type: "email"
        recipients: ["cfo"]
        template: "large_transaction_hold"
    
    sla:
      acknowledgment_minutes: 60
      resolution_hours: 24

  # 6. Rapid Succession Transactions
  rapid_succession:
    severity: "medium"
    auto_containment: true
    containment_actions:
      - action: "flag_for_review"
        target: "account"
        review_type: "manual"
      - action: "reduce_limits"
        target: "account"
        daily_limit: 5000
        transaction_limit: 1000
    
    detection_sql: |
      WITH windowed_transactions AS (
        SELECT p.account_id::TEXT, p.counterparty_id::TEXT, p.id::TEXT,
               p.txn_ts, p.amount,
               COUNT(*) OVER (
                 PARTITION BY p.account_id, p.counterparty_id
                 ORDER BY p.txn_ts
                 RANGE BETWEEN INTERVAL ':time_window minutes' PRECEDING 
                 AND CURRENT ROW
               ) as txn_count_in_window
        FROM payments p
        WHERE p.tenant_id = :tenant_id AND p.status = 'posted'
        AND p.txn_ts >= NOW() - INTERVAL '1 day'
      )
      SELECT account_id, counterparty_id, COUNT(*)::BIGINT as transaction_count,
             MIN(txn_ts) as first_txn_time, MAX(txn_ts) as last_txn_time,
             SUM(amount) as total_amount, array_agg(id) as transaction_ids
      FROM windowed_transactions
      WHERE txn_count_in_window >= :count_threshold
      GROUP BY account_id, counterparty_id
      HAVING COUNT(*) >= :count_threshold
    
    agent_job: "AML_ALERT_TRIAGE"
    notifications:
      - type: "email"
        recipients: ["compliance"]
        template: "rapid_succession_alert"
    
    sla:
      acknowledgment_minutes: 120
      resolution_hours: 12

# ========================================
# Agent Job Routing & Scheduling
# ========================================
agents:
  scheduler:
    type: "priority_queue"
    max_concurrent_jobs: 10
    retry_attempts: 3
    retry_delay_seconds: 30
    
  routing:
    - event: "gl.unbalanced_detected"
      job_type: "FIN_REPAIR_UNBALANCED"
      priority: "high"
      timeout_minutes: 30
      
    - event: "payment.duplicate_suspect"
      job_type: "FIN_DEDUP_REVIEW"
      priority: "medium"
      timeout_minutes: 60
      
    - event: "kyc.sanction_hit"
      job_type: "COMPLIANCE_CASE_OPEN"
      priority: "critical"
      timeout_minutes: 15
      
    - event: "audit.gap_detected"
      job_type: "SEC_FORENSIC_SNAPSHOT"
      priority: "critical"
      timeout_minutes: 10
      
    - event: "payment.large_unexplained"
      job_type: "FIN_SUPPORTING_DOCS_REQUEST"
      priority: "high"
      timeout_minutes: 45
      
    - event: "payment.rapid_succession"
      job_type: "AML_ALERT_TRIAGE"
      priority: "medium"
      timeout_minutes: 90

  job_definitions:
    FIN_REPAIR_UNBALANCED:
      description: "Repair unbalanced journal entries"
      handler: "redFlagsAgents.repairUnbalancedEntries"
      required_permissions: ["gl.write", "suspense.create"]
      
    FIN_DEDUP_REVIEW:
      description: "Review and resolve duplicate transactions"
      handler: "redFlagsAgents.reviewDuplicateTransactions"
      required_permissions: ["payments.write", "dedup.manage"]
      
    COMPLIANCE_CASE_OPEN:
      description: "Open compliance case for sanctions hit"
      handler: "redFlagsAgents.openComplianceCase"
      required_permissions: ["compliance.write", "entity.freeze"]
      
    SEC_FORENSIC_SNAPSHOT:
      description: "Create forensic snapshot for investigation"
      handler: "redFlagsAgents.createForensicSnapshot"
      required_permissions: ["forensic.create", "user.suspend"]
      
    FIN_SUPPORTING_DOCS_REQUEST:
      description: "Request supporting documentation"
      handler: "redFlagsAgents.requestSupportingDocs"
      required_permissions: ["documents.request", "payments.hold"]
      
    AML_ALERT_TRIAGE:
      description: "Triage AML alerts and apply controls"
      handler: "redFlagsAgents.triageAMLAlert"
      required_permissions: ["aml.write", "limits.modify"]

# ========================================
# Dashboard Configuration
# ========================================
dashboards:
  finance_guard:
    title: "Finance Guard Dashboard"
    title_ar: "لوحة حارس المالية"
    refresh_seconds: 30
    widgets:
      - type: "metric_card"
        title: "Unbalanced Entries"
        title_ar: "القيود غير المتوازنة"
        query: "SELECT COUNT(*) FROM detect_unbalanced_entries() WHERE tenant_id = :tenant_id"
        alert_threshold: 1
        
      - type: "metric_card"
        title: "Suspense Balance"
        title_ar: "رصيد حساب التعليق"
        query: "SELECT COALESCE(SUM(balance), 0) FROM chart_of_accounts WHERE account_code = 'SUSPENSE' AND tenant_id = :tenant_id"
        alert_threshold: 1000
        
      - type: "table"
        title: "Recent Duplicates"
        title_ar: "المكررات الحديثة"
        query: "SELECT * FROM detect_duplicate_transactions(:tenant_id, '24 hours') LIMIT 10"
        
  aml_monitor:
    title: "AML/Anti-Fraud Monitor"
    title_ar: "مراقب مكافحة غسل الأموال"
    refresh_seconds: 60
    widgets:
      - type: "metric_card"
        title: "Sanctions Hits"
        title_ar: "إصابات العقوبات"
        query: "SELECT COUNT(*) FROM red_flags WHERE flag_type = 'sanctioned_entity' AND status = 'active' AND tenant_id = :tenant_id"
        alert_threshold: 1
        
      - type: "chart"
        title: "Velocity Alerts"
        title_ar: "تنبيهات السرعة"
        type: "line"
        query: "SELECT DATE(detected_at) as date, COUNT(*) as count FROM red_flags WHERE flag_type = 'rapid_succession' AND tenant_id = :tenant_id GROUP BY DATE(detected_at) ORDER BY date"
        
  audit_integrity:
    title: "Audit Integrity Monitor"
    title_ar: "مراقب سلامة التدقيق"
    refresh_seconds: 120
    widgets:
      - type: "status_indicator"
        title: "Hash Chain Health"
        title_ar: "صحة سلسلة الهاش"
        query: "SELECT CASE WHEN COUNT(*) = 0 THEN 'healthy' ELSE 'compromised' END FROM detect_audit_gaps(:tenant_id)"
        
      - type: "metric_card"
        title: "Sequence Gaps"
        title_ar: "فجوات التسلسل"
        query: "SELECT COUNT(*) FROM detect_audit_gaps(:tenant_id)"
        alert_threshold: 1

# ========================================
# Database Schema Requirements
# ========================================
database:
  required_tables:
    - red_flags
    - security_incidents
    - evidence_snapshots
    - agent_jobs
    - compliance_cases
    - aml_alerts
    - forensic_snapshots
    - document_requests
    - sanctions_watchlist
    - deduplication_rules
    
  required_functions:
    - detect_unbalanced_entries()
    - detect_duplicate_transactions(VARCHAR, INTERVAL)
    - check_sanctions_screening(VARCHAR, TEXT, TEXT)
    - detect_audit_gaps(VARCHAR)
    - detect_large_unexplained_transactions(VARCHAR, NUMERIC)
    - detect_rapid_succession(VARCHAR, INTERVAL, INTEGER)
    
  required_triggers:
    - gl_enforce_balance ON gl_entries
    - check_duplicate_transaction ON payments
    - screen_for_sanctions ON counterparties
    - monitor_large_transactions ON payments
    - check_rapid_succession ON payments
    
  required_indexes:
    - idx_red_flags_tenant_status
    - idx_payments_signature
    - idx_sanctions_name_trgm
    - idx_audit_logs_sequence

# ========================================
# Deployment Configuration
# ========================================
deployment:
  environment_variables:
    required:
      - DATABASE_URL
      - SLACK_WEBHOOK_URL
      - SMTP_HOST
      - TWILIO_API_KEY
    optional:
      - FORENSIC_STORAGE_PATH
      - EVIDENCE_ENCRYPTION_KEY
      
  health_checks:
    - name: "database_connection"
      query: "SELECT 1"
      timeout_seconds: 5
      
    - name: "red_flags_detection"
      query: "SELECT COUNT(*) FROM red_flags WHERE created_at >= NOW() - INTERVAL '1 hour'"
      timeout_seconds: 10
      
    - name: "agent_scheduler"
      endpoint: "/api/agents/health"
      timeout_seconds: 5

# ========================================
# Compliance & Regulatory
# ========================================
compliance:
  retention_policies:
    red_flags: "7 years"
    evidence_snapshots: "permanent"
    audit_logs: "7 years"
    forensic_data: "permanent"
    
  regulatory_requirements:
    saudi_arabia:
      - "SAMA Cyber Security Framework"
      - "KSA Anti-Money Laundering Law"
      - "Data Protection Regulation"
      
  reporting:
    suspicious_activity:
      threshold_amount: 40000  # SAR
      filing_deadline_days: 15
      authority: "SAMA/FIU"
      
    large_transactions:
      threshold_amount: 100000  # SAR
      reporting_deadline_days: 30
      
# ========================================
# Testing & Validation
# ========================================
testing:
  scenarios:
    - name: "unbalanced_journal_entry"
      description: "Test detection and repair of unbalanced GL entries"
      setup_sql: "INSERT INTO gl_entries (tenant_id, journal_id, account_id, debit, credit) VALUES ('test', 'J001', 'A001', 1000, 900)"
      expected_result: "red_flag_created"
      
    - name: "duplicate_payment"
      description: "Test duplicate transaction detection"
      setup_sql: "INSERT INTO payments (tenant_id, amount, counterparty_id, reference) VALUES ('test', 5000, 'C001', 'REF123'), ('test', 5000, 'C001', 'REF123')"
      expected_result: "duplicate_flagged"
      
    - name: "sanctions_screening"
      description: "Test sanctions list screening"
      setup_sql: "INSERT INTO counterparties (tenant_id, name) VALUES ('test', 'SANCTIONED ENTITY')"
      expected_result: "sanctions_hit"

# ========================================
# Monitoring & Alerting
# ========================================
monitoring:
  metrics:
    - name: "red_flags_per_hour"
      query: "SELECT COUNT(*) FROM red_flags WHERE detected_at >= NOW() - INTERVAL '1 hour'"
      alert_threshold: 10
      
    - name: "agent_job_success_rate"
      query: "SELECT (COUNT(CASE WHEN status = 'completed' THEN 1 END) * 100.0 / COUNT(*)) FROM agent_jobs WHERE created_at >= NOW() - INTERVAL '24 hours'"
      alert_threshold: 95  # Below 95% success rate
      
    - name: "incident_response_time"
      query: "SELECT AVG(EXTRACT(EPOCH FROM (resolved_at - detected_at))/60) FROM red_flags WHERE resolved_at IS NOT NULL AND detected_at >= NOW() - INTERVAL '24 hours'"
      alert_threshold: 240  # Above 4 hours average
      
  alerts:
    - condition: "critical_red_flag_detected"
      channels: ["slack", "email", "sms"]
      escalation_minutes: 15
      
    - condition: "agent_job_failed"
      channels: ["slack", "email"]
      escalation_minutes: 60
      
    - condition: "sla_breach"
      channels: ["email"]
      escalation_minutes: 30
