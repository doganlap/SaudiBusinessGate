# =====================================================
# DoganHub Store - Production Docker Compose
# Enterprise Business Management Platform
# =====================================================
version: '3.8'

# Global configuration
x-common-variables: &common-variables
  TZ: Asia/Riyadh
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.production
      args:
        - NODE_ENV=production
    ports:
      - "3003:3000"
    depends_on:
      - postgres
      - redis
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/doganhubstore
      - REDIS_URL=redis://redis:6379
      - NODE_ENV=production
      - NEXTAUTH_URL=http://localhost:3003
      - NEXTAUTH_SECRET=doganhub-production-secret-2025
      - NEXT_PUBLIC_APP_URL=http://localhost:3003
      - NEXT_PUBLIC_API_URL=http://localhost:3003/api
      - BILLING_SERVICE_URL=http://billing:3001
      - AUTH_SERVICE_URL=http://localhost:3003
      - POSTGRES_URL=postgresql://postgres:postgres@postgres:5432/doganhubstore
      - REDIS_CONNECTION_STRING=redis://redis:6379
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
      - ./data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:13-alpine
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=doganhubstore
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d doganhubstore"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command: [
      "postgres",
      "-c", "log_statement=all",
      "-c", "log_destination=stderr",
      "-c", "max_connections=200",
      "-c", "shared_buffers=256MB",
      "-c", "effective_cache_size=1GB"
    ]

  redis:
    image: redis:6-alpine
    ports:
      - "6390:6379"
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command: redis-server /usr/local/etc/redis/redis.conf --appendonly yes

  # Monitoring and Management
  adminer:
    image: adminer:4-standalone
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    restart: unless-stopped
    environment:
      - ADMINER_DEFAULT_SERVER=postgres
      - ADMINER_DESIGN=lucas

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/postgres
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/redis

networks:
  default:
    name: doganhub-network
    driver: bridge