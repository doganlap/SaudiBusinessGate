// Prisma Schema for Saudi Store Multi-tenant Platform
// Database: Prisma PostgreSQL Cloud

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================================================
// SUBSCRIPTION PLANS
// =====================================================
model SubscriptionPlan {
  id                      String   @id @default(uuid())
  name                    String   @db.VarChar(100)
  slug                    String   @unique @db.VarChar(100)
  displayName             Json     // {en: "Professional", ar: "احترافي"}
  description             Json?
  
  // Pricing
  priceMonthly            Decimal  @db.Decimal(10, 2)
  priceYearly             Decimal? @db.Decimal(10, 2)
  currency                String   @default("SAR") @db.VarChar(3)
  
  // Plan Type
  planType                String   @default("standard") @db.VarChar(50)
  
  // Features & Limits
  maxUsers                Int      @default(5)
  maxTeams                Int      @default(1)
  maxStorageGb            Int      @default(10)
  maxApiCallsPerMonth     Int      @default(10000)
  
  // Module Access
  enabledModules          Json     @default("[]")
  features                Json     @default("{}")
  
  // White-label Features
  allowWhiteLabel         Boolean  @default(false)
  allowCustomBranding     Boolean  @default(false)
  allowCustomDomain       Boolean  @default(false)
  allowReselling          Boolean  @default(false)
  resellerCommissionRate  Decimal  @default(0) @db.Decimal(5, 2)
  
  // Status
  isActive                Boolean  @default(true)
  isPublic                Boolean  @default(true)
  
  // Metadata
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  // Relations
  tenantSubscriptions     TenantSubscription[]
  
  @@map("subscription_plans")
}

// =====================================================
// MODULES
// =====================================================
model Module {
  id                String   @id @default(uuid())
  name              String   @unique @db.VarChar(100)
  slug              String   @unique @db.VarChar(100)
  displayName       Json     // {en: "CRM", ar: "إدارة العملاء"}
  description       Json?
  
  // Module Type
  moduleType        String   @default("core") @db.VarChar(50)
  category          String   @db.VarChar(50)
  basePath          String   @db.VarChar(200)
  icon              String?  @db.VarChar(50)
  
  // Pricing
  monthlyPrice      Decimal  @default(0) @db.Decimal(10, 2)
  
  // Status
  isActive          Boolean  @default(true)
  isBeta            Boolean  @default(false)
  sortOrder         Int      @default(0)
  
  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  tenantModules     TenantModule[]
  
  @@map("modules")
}

// =====================================================
// TENANTS
// =====================================================
model Tenant {
  id                    String   @id @default(uuid())
  name                  String   @db.VarChar(255)
  slug                  String   @unique @db.VarChar(100)
  domain                String?  @unique @db.VarChar(255)
  
  // Subscription
  subscriptionTier      String   @default("free") @db.VarChar(50)
  subscriptionStatus    String   @default("active") @db.VarChar(50)
  trialEndsAt           DateTime?
  
  // Limits
  maxUsers              Int      @default(5)
  maxTeams              Int      @default(1)
  maxStorageGb          Int      @default(10)
  
  // Features
  features              Json     @default("{}")
  
  // Contact
  contactEmail          String?  @db.VarChar(255)
  contactPhone          String?  @db.VarChar(50)
  
  // Status
  isActive              Boolean  @default(true)
  
  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  users                 User[]
  teams                 Team[]
  tenantModules         TenantModule[]
  whiteLabelConfig      WhiteLabelConfig?
  resellerConfig        ResellerConfig?
  tenantSubscriptions   TenantSubscription[]
  
  @@index([slug])
  @@index([domain])
  @@map("tenants")
}

// =====================================================
// USERS
// =====================================================
model User {
  id                String    @id @default(uuid())
  tenantId          String
  
  // Authentication
  email             String    @unique @db.VarChar(255)
  passwordHash      String    @db.VarChar(255)
  emailVerified     Boolean   @default(false)
  
  // Profile
  fullName          String    @db.VarChar(255)
  avatar            String?   @db.VarChar(500)
  phone             String?   @db.VarChar(50)
  timezone          String?   @default("Asia/Riyadh") @db.VarChar(50)
  language          String?   @default("en") @db.VarChar(10)
  
  // Role
  role              String    @default("user") @db.VarChar(50)
  userType          String    @default("regular") @db.VarChar(50)
  permissions       Json      @default("[]")
  
  // Status
  isActive          Boolean   @default(true)
  lastLoginAt       DateTime?
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userTeams         UserTeam[]
  
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// =====================================================
// TEAMS
// =====================================================
model Team {
  id                String    @id @default(uuid())
  tenantId          String
  name              String    @db.VarChar(255)
  slug              String    @db.VarChar(100)
  description       String?   @db.Text
  
  // Team Type
  teamType          String    @default("department") @db.VarChar(50)
  
  // Hierarchy
  parentTeamId      String?
  teamLeadId        String?
  
  // Status
  isActive          Boolean   @default(true)
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentTeam        Team?     @relation("TeamHierarchy", fields: [parentTeamId], references: [id])
  childTeams        Team[]    @relation("TeamHierarchy")
  userTeams         UserTeam[]
  
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("teams")
}

// =====================================================
// ROLES
// =====================================================
model Role {
  id                String    @id @default(uuid())
  tenantId          String?   @map("tenant_id")
  
  // Role Details
  name              String    @db.VarChar(100)
  slug              String    @db.VarChar(100)
  displayName       Json      // {en: "Manager", ar: "مدير"}
  description       Json?
  
  // Role Type
  roleType          String    @default("tenant") @db.VarChar(50)
  roleLevel         Int       @default(5)
  
  // Permissions
  permissions       Json      @default("[]")
  moduleAccess      Json      @default("{}")
  
  // Status
  isDefault         Boolean   @default(false)
  isSystem          Boolean   @default(false)
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@unique([tenantId, slug], map: "unique_role_slug_per_tenant")
  @@map("roles")
}

// =====================================================
// USER TEAMS (Many-to-Many)
// =====================================================
model UserTeam {
  id                String    @id @default(uuid())
  userId            String
  teamId            String
  roleId            String?
  
  // Team Permissions
  teamPermissions   Json      @default("{}")
  
  // Status
  isActive          Boolean   @default(true)
  joinedAt          DateTime  @default(now())
  
  // Relations
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  team              Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
  @@map("user_teams")
}

// =====================================================
// TENANT MODULES
// =====================================================
model TenantModule {
  id                String    @id @default(uuid())
  tenantId          String
  moduleId          String
  
  // Access
  isEnabled         Boolean   @default(true)
  moduleSettings    Json      @default("{}")
  
  // Trial
  isTrial           Boolean   @default(false)
  trialEndsAt       DateTime?
  
  // Metadata
  enabledAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  module            Module    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  
  @@unique([tenantId, moduleId])
  @@index([tenantId])
  @@map("tenant_modules")
}

// =====================================================
// WHITE LABEL CONFIGS
// =====================================================
model WhiteLabelConfig {
  id                String    @id @default(uuid())
  tenantId          String    @unique
  
  // Branding
  companyName       String    @db.VarChar(255)
  logoUrl           String?   @db.VarChar(500)
  faviconUrl        String?   @db.VarChar(500)
  primaryColor      String?   @db.VarChar(20)
  secondaryColor    String?   @db.VarChar(20)
  
  // Domain
  customDomain      String?   @unique @db.VarChar(255)
  domainVerified    Boolean   @default(false)
  
  // Customization
  customCss         String?   @db.Text
  customJs          String?   @db.Text
  customEmailTemplates Json?
  
  // Branding Control
  hidePoweredBy     Boolean   @default(false)
  customFooter      String?   @db.Text
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("white_label_configs")
}

// =====================================================
// RESELLER CONFIGS
// =====================================================
model ResellerConfig {
  id                        String    @id @default(uuid())
  resellerTenantId          String    @unique @map("reseller_tenant_id")
  
  // Reseller Details
  resellerName              String    @map("reseller_name") @db.VarChar(255)
  resellerCode              String    @unique @map("reseller_code") @db.VarChar(50)
  
  // Commission
  commissionRate            Decimal   @default(20) @map("commission_rate") @db.Decimal(5, 2)
  
  // Limits
  maxClients                Int?      @map("max_clients")
  
  // Permissions
  canWhiteLabel             Boolean   @default(true) @map("can_white_label")
  canManageClients          Boolean   @default(true) @map("can_manage_clients")
  
  // Tracking
  totalRevenue              Decimal   @default(0) @map("total_revenue") @db.Decimal(12, 2)
  totalCommissionEarned     Decimal   @default(0) @map("total_commission_earned") @db.Decimal(12, 2)
  
  // Status
  isActive                  Boolean   @default(true) @map("is_active")
  
  // Metadata
  createdAt                 DateTime  @default(now()) @map("created_at")
  updatedAt                 DateTime  @updatedAt @map("updated_at")
  
  // Relations
  tenant                    Tenant    @relation(fields: [resellerTenantId], references: [id], onDelete: Cascade)
  
  @@map("reseller_configs")
}

// =====================================================
// TENANT SUBSCRIPTIONS
// =====================================================
model TenantSubscription {
  id                String    @id @default(uuid())
  tenantId          String
  planId            String
  
  // Subscription Details
  status            String    @default("active") @db.VarChar(50)
  billingPeriod     String    @default("monthly") @db.VarChar(20)
  
  // Dates
  startDate         DateTime  @default(now())
  endDate           DateTime?
  nextBillingDate   DateTime?
  
  // Pricing
  amount            Decimal   @db.Decimal(10, 2)
  currency          String    @default("SAR") @db.VarChar(3)
  
  // Payment
  paymentMethod     String?   @db.VarChar(50)
  stripeSubscriptionId String? @db.VarChar(255)
  
  // Reseller
  resellerId        String?
  
  // Metadata
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  plan              SubscriptionPlan @relation(fields: [planId], references: [id])
  
  @@index([tenantId])
  @@index([status])
  @@map("tenant_subscriptions")
}

// =====================================================
// DEMO REQUESTS
// =====================================================
model DemoRequest {
  id                String    @id @default(uuid())
  
  // Contact Info
  fullName          String    @db.VarChar(255)
  email             String    @db.VarChar(255)
  phone             String?   @db.VarChar(50)
  companyName       String?   @db.VarChar(255)
  
  // Request Details
  interestedModules Json      @default("[]")
  companySize       String?   @db.VarChar(50)
  message           String?   @db.Text
  
  // Status
  status            String    @default("pending") @db.VarChar(50)
  assignedTo        String?
  
  // Metadata
  requestedAt       DateTime  @default(now())
  respondedAt       DateTime?
  
  @@index([email])
  @@index([status])
  @@map("demo_requests")
}

// =====================================================
// POC REQUESTS
// =====================================================
model PocRequest {
  id                String    @id @default(uuid())
  
  // Contact Info
  fullName          String    @db.VarChar(255)
  email             String    @db.VarChar(255)
  phone             String    @db.VarChar(50)
  companyName       String    @db.VarChar(255)
  
  // Request Details
  industry          String?   @db.VarChar(100)
  companySize       String?   @db.VarChar(50)
  pocScope          String    @db.Text
  requiredModules   Json      @default("[]")
  timeline          String?   @db.VarChar(100)
  budget            String?   @db.VarChar(100)
  
  // Status
  status            String    @default("pending") @db.VarChar(50)
  approvedBy        String?
  
  // Metadata
  requestedAt       DateTime  @default(now())
  respondedAt       DateTime?
  
  @@index([email])
  @@index([status])
  @@map("poc_requests")
}

// =====================================================
// AI AGENTS
// =====================================================
model AIAgent {
  id                  Int       @id @default(autoincrement())
  uuid                String    @unique @default(uuid())
  tenantId            String    @map("tenant_id") @db.VarChar(255)
  name                String    @db.VarChar(255)
  nameAr              String?   @map("name_ar") @db.VarChar(255)
  agentType           String    @map("agent_type") @db.VarChar(100)
  status              String    @default("inactive") @db.VarChar(20)
  description         String?   @db.Text
  descriptionAr       String?   @map("description_ar") @db.Text
  capabilities        Json      @default("[]")
  model               String    @default("gpt-4") @db.VarChar(100)
  provider            String    @default("OpenAI") @db.VarChar(100)
  lastActive          DateTime? @map("last_active")
  tasksCompleted      Int       @default(0) @map("tasks_completed")
  tasksInProgress     Int       @default(0) @map("tasks_in_progress")
  successRate         Decimal   @default(0.00) @map("success_rate") @db.Decimal(5, 2)
  avgResponseTime     Decimal   @default(0.00) @map("avg_response_time") @db.Decimal(8, 2)
  configuration       Json      @default("{}")
  metrics             Json      @default("{}")
  isActive            Boolean   @default(true) @map("is_active")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([status])
  @@index([agentType])
  @@index([isActive])
  @@map("ai_agents")
}

// =====================================================
// THEMES
// =====================================================
model Theme {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  tenantId      String   @map("tenant_id") @db.VarChar(255)
  name          String   @db.VarChar(255)
  nameAr        String?  @map("name_ar") @db.VarChar(255)
  description   String?  @db.Text
  descriptionAr String?  @map("description_ar") @db.Text
  isDefault     Boolean  @default(false) @map("is_default")
  isActive      Boolean  @default(true) @map("is_active")
  colors        Json     @default("{}")
  typography    Json     @default("{}")
  spacing       Json     @default("{}")
  borderRadius  Json     @default("{}") @map("border_radius")
  shadows       Json     @default("{}")
  branding      Json     @default("{}")
  customCss     String?  @map("custom_css") @db.Text
  version       String   @default("1.0.0") @db.VarChar(20)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([isActive])
  @@index([isDefault])
  @@map("themes")
}

// =====================================================
// WEBHOOK CONFIGURATIONS
// =====================================================
model TenantWebhookConfig {
  id             Int       @id @default(autoincrement())
  uuid           String    @unique @default(uuid())
  tenantId       String    @map("tenant_id") @db.VarChar(255)
  eventType      String    @map("event_type") @db.VarChar(100)
  webhookUrl     String    @map("webhook_url") @db.VarChar(500)
  secretKey      String?   @map("secret_key") @db.VarChar(255)
  httpMethod     String    @default("POST") @map("http_method") @db.VarChar(10)
  headers        Json      @default("{}")
  timeoutSeconds Int       @default(30) @map("timeout_seconds")
  retryAttempts  Int       @default(3) @map("retry_attempts")
  isActive       Boolean   @default(true) @map("is_active")
  lastTriggered  DateTime? @map("last_triggered")
  successCount   Int       @default(0) @map("success_count")
  failureCount   Int       @default(0) @map("failure_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([eventType])
  @@index([isActive])
  @@map("tenant_webhook_configs")
}

// =====================================================
// NOTIFICATIONS
// =====================================================
model Notification {
  id           Int       @id @default(autoincrement())
  uuid         String    @unique @default(uuid())
  tenantId     String?   @map("tenant_id") @db.VarChar(255)
  userId       String?   @map("user_id") @db.VarChar(255)
  type         String    @db.VarChar(100)
  title        String    @db.VarChar(255)
  message      String    @db.Text
  messageAr    String?   @map("message_ar") @db.Text
  severity     String    @default("info") @db.VarChar(20)
  category     String    @default("general") @db.VarChar(50)
  data         Json      @default("{}")
  isRead       Boolean   @default(false) @map("is_read")
  readAt       DateTime? @map("read_at")
  expiresAt    DateTime? @map("expires_at")
  actionUrl    String?   @map("action_url") @db.VarChar(500)
  actionLabel  String?   @map("action_label") @db.VarChar(100)
  actionLabelAr String?  @map("action_label_ar") @db.VarChar(100)
  priority     Int       @default(0)
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([severity])
  @@index([isRead])
  @@index([createdAt])
  @@index([expiresAt])
  @@map("notifications")
}

// =====================================================
// WORKFLOW TEMPLATES
// =====================================================
model WorkflowTemplate {
  id               Int                 @id @default(autoincrement())
  uuid             String              @unique @default(uuid())
  tenantId         String              @map("tenant_id") @db.VarChar(255)
  name             String              @db.VarChar(255)
  nameAr           String?             @map("name_ar") @db.VarChar(255)
  description      String?             @db.Text
  descriptionAr    String?             @map("description_ar") @db.Text
  category         String              @default("general") @db.VarChar(50)
  version          String              @default("1.0.0") @db.VarChar(20)
  nodes            Json                @default("[]")
  edges            Json                @default("[]")
  variables        Json                @default("{}")
  settings         Json                @default("{}")
  isActive         Boolean             @default(true) @map("is_active")
  isPublished      Boolean             @default(false) @map("is_published")
  createdBy        String?             @map("created_by") @db.VarChar(255)
  updatedBy        String?             @map("updated_by") @db.VarChar(255)
  tags             String[]
  executionCount   Int                 @default(0) @map("execution_count")
  successRate      Decimal             @default(0.00) @map("success_rate") @db.Decimal(5, 2)
  avgExecutionTime Int                 @default(0) @map("avg_execution_time")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")

  // Relations
  executions       WorkflowExecution[]

  @@index([tenantId])
  @@index([category])
  @@index([isActive])
  @@index([isPublished])
  @@index([createdBy])
  @@map("workflow_templates")
}

// =====================================================
// WORKFLOW EXECUTIONS
// =====================================================
model WorkflowExecution {
  id                 Int               @id @default(autoincrement())
  uuid               String            @unique @default(uuid())
  workflowTemplateId Int               @map("workflow_template_id")
  tenantId           String            @map("tenant_id") @db.VarChar(255)
  executedBy         String?           @map("executed_by") @db.VarChar(255)
  triggerType        String            @default("manual") @map("trigger_type") @db.VarChar(50)
  triggerData        Json              @default("{}") @map("trigger_data")
  status             String            @default("pending") @db.VarChar(20)
  inputData          Json              @default("{}") @map("input_data")
  outputData         Json              @default("{}") @map("output_data")
  executionLog       Json              @default("[]") @map("execution_log")
  currentStep        String?           @map("current_step") @db.VarChar(255)
  progressPercentage Int               @default(0) @map("progress_percentage")
  startedAt          DateTime          @default(now()) @map("started_at")
  completedAt        DateTime?         @map("completed_at")
  durationSeconds    Int?              @map("duration_seconds")
  errorMessage       String?           @map("error_message") @db.Text
  errorCode          String?           @map("error_code") @db.VarChar(50)
  retryCount         Int               @default(0) @map("retry_count")
  maxRetries         Int               @default(3) @map("max_retries")
  nextRetryAt        DateTime?         @map("next_retry_at")
  priority           Int               @default(0)
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")

  // Relations
  workflowTemplate   WorkflowTemplate  @relation(fields: [workflowTemplateId], references: [id], onDelete: Cascade)

  @@index([workflowTemplateId])
  @@index([tenantId])
  @@index([status])
  @@index([executedBy])
  @@index([triggerType])
  @@index([startedAt])
  @@index([completedAt])
  @@index([priority])
  @@index([nextRetryAt])
  @@map("workflow_executions")
}
